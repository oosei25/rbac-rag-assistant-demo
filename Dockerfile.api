# Backend (FastAPI) image
FROM python:3.11-slim

ENV PIP_NO_CACHE_DIR=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# System deps: build tools + OpenMP runtime (for sentence-transformers/torch)
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential curl git libgomp1 \
  && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Install Python deps first (better layer caching)
COPY requirements.api.txt /tmp/requirements.txt
RUN python -m pip install --upgrade pip && \
    pip install -r /tmp/requirements.txt

# Copy app code and data
COPY app ./app
COPY resources ./resources

# Environment defaults (can be overridden by docker-compose or .env)
ENV VECTOR_DB=qdrant \
    QDRANT_URL=http://qdrant:6333 \
    DATA_DIR=/app/resources/data \
    EMBED_BACKEND=local \
    ST_MODEL=sentence-transformers/all-MiniLM-L6-v2 \
    OLLAMA_HOST=http://ollama:11434 \
    OLLAMA_MODEL=llama3.1:8b-instruct

EXPOSE 8000
CMD ["uvicorn", "app.main:app", "--host","0.0.0.0", "--port","8000"]
