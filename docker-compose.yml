services:
  qdrant:
    image: qdrant/qdrant:latest
    ports: ["6333:6333"]
    volumes:
      - qdrant_storage:/qdrant/storage

  ollama:
    image: ollama/ollama:latest
    ports: ["11434:11434"]
    volumes:
      - ollama_models:/root/.ollama
    restart: unless-stopped

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    env_file: .env
    environment:
      VECTOR_DB: ${VECTOR_DB:-qdrant}
      QDRANT_URL: ${QDRANT_URL:-http://qdrant:6333}
      DATA_DIR: /app/resources/data
      EMBED_BACKEND: ${EMBED_BACKEND:-local}
      ST_MODEL: ${ST_MODEL:-sentence-transformers/all-MiniLM-L6-v2}
      OLLAMA_HOST: ${OLLAMA_HOST:-http://ollama:11434}
      OLLAMA_MODEL: "${OLLAMA_MODEL:-qwen2.5:3b-instruct}"
      AUTO_INDEX: ${AUTO_INDEX:-0}
      RBAC_INTENT: "${RBAC_INTENT:-1}"
      RBAC_INTENT_SOFT: "${RBAC_INTENT_SOFT:-1}"
      RETRIEVAL_FILTERS: "${RETRIEVAL_FILTERS:-1}"
    depends_on:
      - qdrant
      - ollama
    ports: ["8000:8000"]
    volumes:
      - ./resources:/app/resources:ro

  web:
    build:
      context: .
      dockerfile: Dockerfile.streamlit
    environment:
      API_URL: http://api:8000
    depends_on:
      - api
    ports: ["8501:8501"]
    volumes:
      - .:/app

volumes:
  qdrant_storage:
  ollama_models:
